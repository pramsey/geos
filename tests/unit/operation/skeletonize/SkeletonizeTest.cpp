//
// Test Suite for geos::operation::skeletonize::Skeletonizer class.
//

// tut
#include <tut/tut.hpp>
// geos
#include <geos/operation/skeletonize/Skeletonizer.h>
#include <geos/operation/skeletonize/SegmentGraph.h>
#include <geos/operation/skeletonize/InputOutputs.h>
#include <geos/operation/distance/GeometryLocation.h>
#include <geos/geom/GeometryFactory.h>
#include <geos/geom/Geometry.h>
#include <geos/geom/MultiLineString.h>
#include <geos/geom/MultiPoint.h>
#include <geos/geom/Polygon.h>
#include <geos/io/WKBReader.h>
#include <geos/io/WKTReader.h>
#include <geos/io/WKTWriter.h>
// std
#include <memory>
#include <string>
#include <vector>
#include <iostream>

namespace tut {
//
// Test Group
//

using geos::geom::Geometry;
using geos::geom::Polygon;
using geos::geom::MultiLineString;
using geos::geom::MultiPoint;
using namespace geos::operation::skeletonize;
using geos::operation::distance::GeometryLocation;

// Common data used by tests
struct test_skeletonizetest_data {

    geos::io::WKTReader _r;
    geos::io::WKTWriter _w;

    test_skeletonizetest_data() {};

    std::unique_ptr<MultiPoint>
    read_mpoint(const std::string& wkt)
    {
        std::unique_ptr<MultiPoint> g = _r.read<MultiPoint>(wkt);
        return g;
    }

    std::unique_ptr<Polygon>
    read_polygon(const std::string& wkt)
    {
        std::unique_ptr<Polygon> g = _r.read<Polygon>(wkt);
        return g;
    }

    std::unique_ptr<MultiLineString>
    read_mline(const std::string& wkt)
    {
        std::unique_ptr<MultiLineString> g = _r.read<MultiLineString>(wkt);
        return g;
    }

    std::vector<const Geometry*>
    read_edge_vector(const std::string& wkt)
    {
        auto mline = read_mline(wkt);
        std::vector<const Geometry*> edges;
        for (std::size_t i = 0; i < mline->getNumGeometries(); i++) {
            edges.push_back(mline->getGeometryN(i));
        }
        return edges;
    }

};

typedef test_group<test_skeletonizetest_data> group;
typedef group::object object;

group test_skeletonizetest_group("geos::operation::skeletonize::skeletonize");

template<>
template<>
void object::test<1> ()
{
    auto poly = read_polygon("POLYGON ((100 130, 120 160, 160 180, 270 180, 330 180, 420 170, 430 120, 450 80, 430 50, 350 50, 260 30, 170 30, 130 30, 90 80, 100 130))");
    auto mpoint = read_mpoint("MULTIPOINT((450 80),(160 180), (100 130))");
    auto output = Skeletonizer::skeletonize(*poly, *mpoint);
    std::cout << _w.write(*output) << std::endl;
}


template<>
template<>
void object::test<2> ()
{
    auto edges = read_edge_vector("MULTILINESTRING ((0 0, 1 1), (1 1, 2 2), (1 1, 2 1))");
    std::vector<GeometryLocation> locs;
    auto gf = geos::geom::GeometryFactory::create();

    SegmentGraph sg(edges, locs, gf.get());
    sg.build();
    std::cout << sg << std::endl;

    auto endVertices = sg.endVertices();
    std::cout << "endVertices" << std::endl;
    for (auto i : endVertices)
        std::cout << i << " ";
    std::cout << std::endl;

    auto result = sg.shortestPath(endVertices[0], endVertices[1]);
    std::cout << "shortestPath" << std::endl;
    std::cout << "  cost: " << result.second << std::endl;
    std::cout << "  path: ";
    for (auto i : result.first)
        std::cout << i << " ";
    std::cout << std::endl;

    auto r2 = sg.longestPath(endVertices);
    std::cout << "longestPath" << std::endl;
    std::cout << "  path: ";
    for (auto i : r2)
        std::cout << i << " ";
    std::cout << std::endl;

}


template<>
template<>
void object::test<3> ()
{
    auto edges = read_edge_vector("MULTILINESTRING ((109.32234557539121 84.70132690260043, 96.2105296623879 81.51108622228391), (123.124918076622 88.05963581866563, 109.32234557539121 84.70132690260043), (132.5446107838086 92.29452069353957, 132.08696511476742 90.24019473054352), (132.08696511476742 90.24019473054352, 123.124918076622 88.05963581866563), (132.08696511476742 90.24019473054352, 132.54461078380862 87.91164089949557), (132.5446107838086 92.29452069353957, 134.29956983732208 98.06235229914832), (134.29956983732208 98.06235229914832, 136.14861347139382 102.82369168499915), (172.1547594742265 55, 167.3158941637413 55), (167.3158941637413 55, 161.63178832748255 55.61026966596057), (161.63178832748255 55.61026966596057, 155.63178832748255 56.974455066662664), (155.63178832748255 56.974455066662664, 149.63178832748255 59.05864046736476), (149.63178832748255 59.05864046736476, 145.00549451186785 61.22080473021561), (145.00549451186785 61.22080473021561, 142.2644469978624 64.9525135310609), (142.2644469978624 64.9525135310609, 139.15948794434897 70.15229537316951), (139.15948794434897 70.15229537316951, 136.5045288908355 75.71207721527823), (136.5045288908355 75.71207721527823, 134.29956983732208 81.63185905738683), (134.29956983732208 81.63185905738683, 132.54461078380862 87.91164089949557), (136.45327668663072 103.75043434559788, 136.14861347139382 102.82369168499915), (138.65022131818145 109.42986883559911, 138.07270972394855 107.68066483820886), (138.07270972394855 107.68066483820886, 136.45327668663072 103.75043434559788), (129.51981134649907 117.37477424624684, 140.3045413211546 113.47260495971526), (140.3045413211546 113.47260495971526, 140.26751837472025 113.36092192155998), (140.26751837472025 113.36092192155998, 138.65022131818145 109.42986883559911), (111.64959392202738 125.83915532744572, 129.51981134649907 117.37477424624684), (140.49449910676807 113.82032108854668, 140.3045413211546 113.47260495971526), (143.70385732268338 118.891851495531, 143.45890211259578 118.44323395264922), (143.45890211259578 118.44323395264922, 140.49449910676807 113.82032108854668), (146.91321522876117 123.96338210907378, 146.6683536418902 123.51470530888693), (146.6683536418902 123.51470530888693, 143.70385732268338 118.891851495531), (148.9747163830958 127.17795649406715, 143.34908545848654 133.55057117351816), (151.8649292194556 129.9352915165785, 150.29233192609885 128.3374606121761), (150.29233192609885 128.3374606121761, 148.9747163830958 127.17795649406715), (148.9747163830958 127.17795649406715, 146.91321522876117 123.96338210907378), (143.34908545848654 133.55057117351816, 127.87845264654136 151.07542893240966), (127.87845264654136 151.07542893240966, 120.07156812028448 159.9189289059276), (145.00549451186785 61.22080473021561, 143.63178832748255 58.36263750983759), (137.63178832748255 45.87888842491819, 143.63178832748255 58.36263750983759), (137.63178832748255 45.87888842491819, 132.3158941637413 34.81850694122923), (156.4490262481256 134.18350532423767, 154.87950421145655 132.58229951477585), (154.87950421145655 132.58229951477585, 151.8649292194556 129.9352915165785), (161.03302133114212 138.43192302320296, 159.46685609267655 136.82703065985802), (159.46685609267655 136.82703065985802, 156.4490262481256 134.18350532423767), (165.6168995032786 142.6805745439291, 164.05441313111618 141.0716387106088), (164.05441313111618 141.0716387106088, 161.03302133114212 138.43192302320296), (165.66584679535575 155.99908782477348, 168.26527416902647 144.98773676733077), (168.26527416902647 144.98773676733077, 165.6168995032786 142.6805745439291), (161.33292339767794 174.35364587863617, 165.66584679535575 155.99908782477348), (172.1547594742265 55, 172.6841058362587 54.95437543645055), (171.6658467953559 147.06175762175758, 168.76384468895955 145.2431220497171), (168.76384468895955 145.2431220497171, 168.26527416902647 144.98773676733077), (172.6841058362587 54.95437543645055, 177.309518948453 55.052313260603995), (177.309518948453 55.052313260603995, 178.36821167251745 54.947686739396005), (177.6658467953559 150.10185600631485, 171.6658467953559 147.06175762175758), (183.309518948453 55.052313260603995, 178.36821167251745 54.947686739396005), (183.309518948453 55.052313260603995, 184.36821167251745 54.947686739396005), (189.309518948453 55.052313260603995, 184.36821167251745 54.947686739396005), (183.6658467953559 152.42195439087214, 177.6658467953559 150.10185600631485), (189.309518948453 55.052313260603995, 190.36821167251745 54.947686739396005), (195.309518948453 55.052313260603995, 190.36821167251745 54.947686739396005), (189.6658467953559 154.02205277542944, 183.6658467953559 152.42195439087214), (189.6658467953559 154.02205277542944, 195.6658467953559 154.90215115998674), (195.6658467953559 154.90215115998674, 200.13792181945487 155.02147982448295), (195.309518948453 55.052313260603995, 196.36821167251745 54.947686739396005), (201.309518948453 55.052313260603995, 196.36821167251745 54.947686739396005), (207.309518948453 55.052313260603995, 202.36821167251745 54.947686739396005), (202.36821167251745 54.947686739396005, 201.309518948453 55.052313260603995), (213.309518948453 55.052313260603995, 208.36821167251745 54.947686739396005), (208.36821167251745 54.947686739396005, 207.309518948453 55.052313260603995), (205.3581679805216 155.17985128600233, 207.66584679535592 155.4489199286342), (207.66584679535592 155.4489199286342, 211.35824092230962 155.4285434572983), (201.6658467953559 155.1984809456531, 200.13792181945487 155.02147982448295), (205.3581679805216 155.17985128600233, 201.6658467953559 155.1984809456531), (219.309518948453 55.052313260603995, 214.36821167251745 54.947686739396005), (214.36821167251745 54.947686739396005, 213.309518948453 55.052313260603995), (213.66584679535592 155.69937676893736, 211.35824092230962 155.4285434572983), (217.35831536461257 155.67721762241814, 213.66584679535592 155.69937676893736), (219.6658467953559 155.94985202109083, 217.35831536461257 155.67721762241814), (219.309518948453 55.052313260603995, 220.36821167251745 54.947686739396005), (225.309518948453 55.052313260603995, 220.36821167251745 54.947686739396005), (223.3583913542127 155.92587321996922, 219.6658467953559 155.94985202109083), (225.6658467953559 156.2003462628231, 223.3583913542127 155.92587321996922), (225.309518948453 55.052313260603995, 226.36821167251745 54.947686739396005), (231.309518948453 55.052313260603995, 226.36821167251745 54.947686739396005), (229.35846893985837 156.1745096649764, 225.6658467953559 156.2003462628231), (231.6658467953559 156.45086009628866, 229.35846893985837 156.1745096649764), (231.309518948453 55.052313260603995, 232.36821167251745 54.947686739396005), (237.309518948453 55.052313260603995, 232.36821167251745 54.947686739396005), (235.35854817236654 156.42312634763084, 231.6658467953559 156.45086009628866), (237.6658467953559 156.7013941493729, 235.35854817236654 156.42312634763084), (237.309518948453 55.052313260603995, 238.36821167251745 54.947686739396005), (237.6658467953559 156.7013941493729, 241.3586291047355 156.67172263195786), (243.309518948453 55.052313260603995, 238.36821167251745 54.947686739396005), (243.6658467953559 156.95194907708128, 241.3586291047355 156.67172263195786), (243.309518948453 55.052313260603995, 244.36821167251745 54.947686739396005), (248.1547594742265 55.02786255153583, 244.36821167251745 54.947686739396005), (243.6658467953559 156.95194907708128, 247.35871179226152 156.9202978543984), (249.6658467953559 157.2025255630196, 247.35871179226152 156.9202978543984), (248.1547594742265 55.02786255153583, 250.36821167251745 54.91135579835778), (253.92240475175387 55.15078129067508, 250.36821167251745 54.91135579835778), (253.35879629266623 157.16885132229706, 249.6658467953559 157.2025255630196), (255.6658467953559 157.4531243209722, 253.35879629266623 157.16885132229706), (253.92240475175387 55.15078129067508, 256.3682116725174 55.13573293070118), (258.7531533624277 55.52622001068832, 258.0866703860169 55.35170023527533), (258.0866703860169 55.35170023527533, 257.23009258569675 55.2332256387413), (257.23009258569675 55.2332256387413, 256.3682116725174 55.13573293070118), (259.3588826662296 157.41738231228962, 255.6658467953559 157.4531243209722), (261.6658467953559 157.70374609658592, 259.3588826662296 157.41738231228962), (257.23009258569675 55.2332256387413, 259.6841058362587 32.877723880041735), (264.69856102412905 56.430895543026004, 264.03225570928737 56.255199652436914), (264.03225570928737 56.255199652436914, 258.7531533624277 55.52622001068832), (265.35897097593477 157.66589006858217, 261.6658467953559 157.70374609658592), (267.332923397678 157.91275573354713, 265.35897097593477 157.66589006858217), (270.64396699448275 57.33559137153498, 269.97784526171614 57.15868003838609), (269.97784526171614 57.15868003838609, 264.69856102412905 56.430895543026004), (287.8146415093775 59.868997039545754, 288.48017385752973 60.04981143323308), (288.48017385752973 60.04981143323308, 293.76025027260914 60.77239097688227), (396.56365624544634 78.707847914078, 402.56365624544634 83.14239635089496), (267.332923397678 157.91275573354713, 271.3577721354961 157.92984362659857), (276.58937118657894 58.2403085391353, 275.92343925736986 58.062140429822875), (275.92343925736986 58.062140429822875, 270.64396699448275 57.33559137153498), (293.76025027260914 60.77239097688227, 294.42557213006586 60.954599635553), (294.42557213006586 60.954599635553, 299.7058644958148 61.67576034433543), (272.667076602322 158.11480591675522, 271.3577721354961 157.92984362659857), (272.667076602322 158.11480591675522, 277.3557039006519 158.20422991748234), (282.5347735074492 59.14504816144617, 281.8690379250104 58.965579797319265), (281.8690379250104 58.965579797319265, 276.58937118657894 58.2403085391353), (390.56365624544634 75.17329947726105, 396.56365624544634 78.707847914078), (278.3341532046441 158.35867600102134, 277.3557039006519 158.20422991748234), (278.3341532046441 158.35867600102134, 283.35575827594573 158.4531448867121), (287.8146415093775 59.868997039545754, 282.5347735074492 59.14504816144617), (384.56365624544634 72.5387510404441, 390.56365624544634 75.17329947726105), (299.7058644958148 61.67576034433543, 300.37096821045077 61.859414143688234), (300.37096821045077 61.859414143688234, 305.65148448082397 62.579103783672736), (284.3341532046441 158.60891101720478, 283.35575827594573 158.4531448867121), (284.3341532046441 158.60891101720478, 289.355813924005 158.702044582753), (305.65148448082397 62.579103783672736, 306.31636197549 62.76425643597181), (306.31636197549 62.76425643597181, 311.5971105521308 63.4824198346709), (290.3341532046441 158.85916181303367, 289.355813924005 158.702044582753), (290.3341532046441 158.85916181303367, 295.355870890047 158.95092846300406), (311.5971105521308 63.4824198346709, 312.2617532925818 63.669128103623784), (312.2617532925818 63.669128103623784, 317.54274305906193 64.38570692535937), (296.3341532046441 159.10942895470782, 295.355870890047 158.95092846300406), (296.3341532046441 159.10942895470782, 301.35592922145554 159.19979595885405), (378.56365624544634 70.80420260362715, 384.56365624544634 72.5387510404441), (302.3341532046441 159.3597130358434, 301.35592922145554 159.19979595885405), (302.3341532046441 159.3597130358434, 307.3559889679143 159.44864647410412), (372.56365624544634 69.9696541668102, 378.56365624544634 70.80420260362715), (308.3341532046441 159.6100146791524, 307.3559889679143 159.44864647410412), (308.3341532046441 159.6100146791524, 313.35605018154615 159.69747938327407), (317.54274305906193 64.38570692535937, 318.20714201880185 64.57403086173625), (318.20714201880185 64.57403086173625, 323.4883823781987 65.28896336112224), (314.3341532046441 159.86033453824749, 313.35605018154615 159.69747938327407), (314.3341532046441 159.86033453824749, 317.34463071685406 159.91186404685484), (366.56365624544634 69.78021322801943, 370.2996815296149 69.99435094750321), (370.2996815296149 69.99435094750321, 372.56365624544634 69.9696541668102), (346.6580446812821 151.12260693050095, 348.5102716728645 150.39985797995297), (348.5102716728645 150.39985797995297, 352.3932107428797 148.37249161786016), (320.3341532046441 160.11110427044784, 317.34463071685406 159.91186404685484), (326.3341532046441 159.6109812897512, 328.83838584292556 159.0266090121065), (328.83838584292556 159.0266090121065, 331.2854242357045 158.3731635319861), (331.2854242357045 158.3731635319861, 337.05109275565275 155.93186938269568), (337.05109275565275 155.93186938269568, 337.2305903398845 155.82683249517288), (320.3341532046441 160.11110427044784, 326.3341532046441 159.6109812897512), (329.667076602322 173.9889398334269, 328.83838584292556 159.0266090121065), (323.4883823781987 65.28896336112224, 324.1525279998788 65.47896656156638), (324.1525279998788 65.47896656156638, 329.43402891608804 66.19218731249926), (340.92213580898886 153.87197943244632, 342.7800957900503 153.16058586344872), (342.7800957900503 153.16058586344872, 346.6580446812821 151.12260693050095), (337.2305903398845 155.82683249517288, 340.92213580898886 153.87197943244632), (330.09791106904527 66.38393720432313, 329.43402891608804 66.19218731249926), (330.09791106904527 66.38393720432313, 335.37968311228286 67.09537680150123), (352.3932107428797 148.37249161786016, 354.2405463182066 147.6400189592074), (354.2405463182066 147.6400189592074, 358.12778721731496 145.62178671805654), (358.12778721731496 145.62178671805654, 359.9709002745489 144.8808937374635), (359.9709002745489 144.8808937374635, 363.86188789764856 142.87060602415167), (360.56365624544634 69.53010972780186, 365.9347698115171 69.83903713118329), (365.9347698115171 69.83903713118329, 366.56365624544634 69.78021322801943), (336.0432910457464 67.28894495666368, 335.37968311228286 67.09537680150123), (341.9886677341851 68.19399216815215, 341.32534544276183 67.99852968622454), (341.32534544276183 67.99852968622454, 336.0432910457464 67.28894495666368), (363.86188789764856 142.87060602415167, 365.70131888371276 142.12235039111243), (365.70131888371276 142.12235039111243, 369.5955990635596 140.11903581582445), (354.56365624544634 69.2799924520398, 359.93472427413946 69.59001610696137), (359.93472427413946 69.59001610696137, 360.56365624544634 69.53010972780186), (347.9331559489644 69.10970106355508, 345.06442521387476 68.60603696985926), (345.06442521387476 68.60603696985926, 341.9886677341851 68.19399216815215), (369.5955990635596 140.11903581582445, 371.43179089004803 139.36428761930677), (371.43179089004803 139.36428761930677, 375.3289873227451 137.36714270077093), (375.3289873227451 137.36714270077093, 377.1623075073194 136.60662634592447), (377.1623075073194 136.60662634592447, 381.0621049151502 134.61497891893748), (353.9346775528546 69.34100928962576, 350.78182812272314 69.15836169169314), (350.78182812272314 69.15836169169314, 347.9331559489644 69.10970106355508), (381.0621049151502 134.61497891893748, 382.8928617767017 133.84930394154048), (382.8928617767017 133.84930394154048, 385.5950727075936 132.4735095239218), (385.5950727075936 132.4735095239218, 386.2075129200283 131.2751055495775), (353.9346775528546 69.34100928962576, 354.56365624544634 69.2799924520398), (386.2075129200283 131.2751055495775, 387.05988814216755 129.87266219898612), (387.05988814216755 129.87266219898612, 389.16407836514486 125.74638962045499), (402.56365624544634 83.14239635089496, 406.19181373186535 86.36815999217866), (406.19181373186535 86.36815999217866, 408.56365624544634 84.7966843173458), (389.16407836514486 125.74638962045499, 390.0201972698941 124.34590060822046), (390.0201972698941 124.34590060822046, 392.12049777126737 120.21752765233941), (389.2157125982347 136.42265050651122, 385.5950727075936 132.4735095239218), (392.12049777126737 120.21752765233941, 392.9807311932207 118.81918397657407), (392.9807311932207 118.81918397657407, 394.29732915150464 116.22452374848051), (394.29732915150464 116.22452374848051, 395.1900849932331 114.61983001353386), (395.1900849932331 114.61983001353386, 400.6936708948756 103.61265821024875), (400.6936708948756 103.61265821024875, 402.5407377128681 99.447912415807), (402.5407377128681 99.447912415807, 404.4958440418752 93.71726164781084), (404.4958440418752 93.71726164781084, 405.9709503708822 87.746610879815), (405.9709503708822 87.746610879815, 406.19181373186535 86.36815999217866), (408.56365624544634 84.7966843173458, 410.9191211100696 83.5124923169093), (410.9191211100696 83.5124923169093, 412.70173379143165 82.32210606958535), (412.70173379143165 82.32210606958535, 414.5636562454463 78.84307214061305), (389.2157125982347 136.42265050651122, 396.0851596715453 143.91536333748442), (414.5636562454463 78.84307214061305, 420.5636562454463 67.63196958968506), (396.0851596715453 143.91536333748442, 402.95460674485616 151.40807616845794), (420.5636562454463 67.63196958968506, 426.56365624544634 56.42086703875703), (402.95460674485616 151.40807616845794, 409.8240538181672 158.90078899943165), (426.56365624544634 56.42086703875703, 429.78182812272314 50.407657881646486), (409.8240538181672 158.90078899943165, 416.6293886774113 166.32357270745916), (420.9301865935402 81.80982112614524, 412.70173379143165 82.32210606958535), (432.8610207221919 81.06703425797187, 420.9301865935402 81.80982112614524), (444.413218893259 80.34782041194258, 432.8610207221919 81.06703425797187))");
    std::vector<GeometryLocation> locs;
    auto gf = geos::geom::GeometryFactory::create();

    SegmentGraph sg(edges, locs, gf.get());
    sg.build();
    std::cout << sg << std::endl;

    auto r2 = sg.longestPathSkeleton();
    std::cout << "longestPath" << std::endl;
    std::cout << "  " << *r2;
    std::cout << std::endl;
}



template<>
template<>
void object::test<4> ()
{
    auto poly = read_polygon("POLYGON((100 100, 200 200, 200 100, 100 100))");
    auto output = Skeletonizer::skeletonize(*poly);
    std::cout << _w.write(*output) << std::endl;
}

template<>
template<>
void object::test<5> ()
{
    auto poly = read_polygon("POLYGON ((0 0, 100 0, 100 20, 0 20, 0 0))");
    auto pts = read_mpoint("MULTIPOINT (0 0, 100.0 20, 100 0, 0 20)");

    // auto outputs = InputOutputs::addInputOutputGaps(
    //     *mline, *pts, 1.0);

    auto output = Skeletonizer::skeletonize(*poly, *pts);
    std::cout << std::endl << "Skeleton" << std::endl << output->toString() << std::endl;
}



} // namespace tut

